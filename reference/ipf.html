<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Adjustment of marginal distributions using iterative proportional fitting — ipf • segregation</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Adjustment of marginal distributions using iterative proportional fitting — ipf" />
<meta property="og:description" content="Adjusts the marginal distributions for group and unit
in source to the respective marginal distributions in target, using the iterative
proportional fitting algorithm (IPF)." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">segregation</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/segregation.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/elbersb/segregation/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Adjustment of marginal distributions using iterative proportional fitting</h1>
    <small class="dont-index">Source: <a href='https://github.com/elbersb/segregation/blob/master/R/ipf.R'><code>R/ipf.R</code></a></small>
    <div class="hidden name"><code>ipf.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Adjusts the marginal distributions for <code>group</code> and <code>unit</code>
in <code>source</code> to the respective marginal distributions in <code>target</code>, using the iterative
proportional fitting algorithm (IPF).</p>
    </div>

    <pre class="usage"><span class='fu'>ipf</span><span class='op'>(</span>
  <span class='va'>source</span>,
  <span class='va'>target</span>,
  <span class='va'>group</span>,
  <span class='va'>unit</span>,
  weight <span class='op'>=</span> <span class='cn'>NULL</span>,
  max_iterations <span class='op'>=</span> <span class='fl'>100</span>,
  precision <span class='op'>=</span> <span class='fl'>1e-04</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>source</th>
      <td><p>A "source" data frame. The marginals of this
dataset are adjusted to the marginals of <code>target</code>.</p></td>
    </tr>
    <tr>
      <th>target</th>
      <td><p>A "target" data frame. The function returns a dataset
where the marginal distributions of <code>group</code> and <code>unit</code> categories
are approximated by those of <code>target</code>.</p></td>
    </tr>
    <tr>
      <th>group</th>
      <td><p>A categorical variable or a vector of variables
contained in <code>source</code> and <code>target</code>. Defines the first distribution
for adjustment.</p></td>
    </tr>
    <tr>
      <th>unit</th>
      <td><p>A categorical variable or a vector of variables
contained in <code>source</code> and <code>target</code>. Defines the second distribution
for adjustment.</p></td>
    </tr>
    <tr>
      <th>weight</th>
      <td><p>Numeric. (Default <code>NULL</code>)</p></td>
    </tr>
    <tr>
      <th>max_iterations</th>
      <td><p>Maximum number of iterations used for the IPF algorithm.</p></td>
    </tr>
    <tr>
      <th>precision</th>
      <td><p>Convergence criterion for the IPF algorithm. In every iteration,
the ratio of the source and target marginals are calculated for every category of
<code>group</code> and <code>unit</code>. The algorithm converges when all ratios are smaller
than <code>1 + precision</code>.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>Returns a data frame that retains
  the association structure of <code>source</code> while approximating
  the marginal distributions for <code>group</code> and <code>unit</code> of <code>target</code>.
  The dataset identifies each combination of <code>group</code> and <code>unit</code>,
  and categories that only occur in either <code>source</code> or <code>target</code> are dropped.
  The adjusted frequency of each combination is given by the column <code>n</code>,
  while <code>n_target</code> and <code>n_source</code> contain the zero-adjusted frequencies
  in the target and source dataset, respectively.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The algorithm works by scaling
the marginal distribution of <code>group</code> in the <code>source</code> data frame towards the
marginal distribution of <code>target</code>; then repeating this process for <code>unit</code>. The
algorithm then keeps alternating between <code>group</code> and <code>unit</code> until the marginals
of the adjusted data frame are within the allowed precision. This results in a dataset that
retains the association structure of <code>source</code> while approximating
the marginal distribution of <code>target</code>. If the number of <code>unit</code> and
<code>group</code> categories is different in <code>source</code> and <code>target</code>, the data frame returns
the combination of <code>unit</code> and <code>group</code> categories that occur in both datasets.
Zero values are replaced by a small, non-zero number (1e-4).
Note that the values returned sum to the observations of the source data frame, not the
target data frame. This is different from other IPF implementations, but ensures that the IPF
does not change the number of observations.</p>
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>W. E. Deming and F. F. Stephan. 1940.
  "On a Least Squares Adjustment of a Sampled Frequency Table
  When the Expected Marginal Totals are Known".
  Annals of Mathematical Statistics. 11 (4): 427–444.</p>
<p>T. Karmel and M. Maclachlan. 1988.
  "Occupational Sex Segregation — Increasing or Decreasing?" Economic Record 64: 187-195.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># adjusts the marginals of group and unit categories so that</span>
<span class='co'># schools00 has similar marginals as schools05</span>
<span class='va'>adj</span> <span class='op'>&lt;-</span> <span class='fu'>ipf</span><span class='op'>(</span><span class='va'>schools00</span>, <span class='va'>schools05</span>, <span class='st'>"race"</span>, <span class='st'>"school"</span>, weight <span class='op'>=</span> <span class='st'>"n"</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='warning'>Warning: IPF procedure removed 335 units from source, this likely reduced the sample size (check columns n_source and n_target)</span></div><div class='output co'>#&gt; <span class='warning'>Warning: IPF procedure removed 210 units from target, this likely reduced the sample size (check columns n_source and n_target)</span></div><div class='input'>
<span class='co'># check that the new "race" marginals are similar to the target marginals</span>
<span class='co'># (the same could be done for schools)</span>
<span class='fu'><a href='https://rdrr.io/r/stats/aggregate.html'>aggregate</a></span><span class='op'>(</span><span class='va'>adj</span><span class='op'>$</span><span class='va'>n</span>, <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>adj</span><span class='op'>$</span><span class='va'>race</span><span class='op'>)</span>, <span class='va'>sum</span><span class='op'>)</span>
</div><div class='output co'>#&gt;   Group.1          x
#&gt; 1   asian  22442.029
#&gt; 2   black 117182.529
#&gt; 3    hisp 146620.992
#&gt; 4  native   6067.165
#&gt; 5   white 439757.285</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/stats/aggregate.html'>aggregate</a></span><span class='op'>(</span><span class='va'>adj</span><span class='op'>$</span><span class='va'>n_target</span>, <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>adj</span><span class='op'>$</span><span class='va'>race</span><span class='op'>)</span>, <span class='va'>sum</span><span class='op'>)</span>
</div><div class='output co'>#&gt;   Group.1      x
#&gt; 1   asian  22508
#&gt; 2   black 117527
#&gt; 3    hisp 147052
#&gt; 4  native   6085
#&gt; 5   white 441050</div><div class='input'>
<span class='co'># note that the adjusted dataset contains fewer</span>
<span class='co'># schools than either the source or the target dataset,</span>
<span class='co'># because the marginals are only defined for the overlap</span>
<span class='co'># of schools</span>
<span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>schools00</span><span class='op'>$</span><span class='va'>school</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] 2045</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>schools05</span><span class='op'>$</span><span class='va'>school</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] 1920</div><div class='input'><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/unique.html'>unique</a></span><span class='op'>(</span><span class='va'>adj</span><span class='op'>$</span><span class='va'>school</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] 1710</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Benjamin Elbers.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


