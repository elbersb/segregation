<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>A walkthrough of the segregation package ‚Ä¢ segregation</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="A walkthrough of the segregation package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">segregation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/segregation.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/faq.html">FAQ</a></li>
    <li><a class="dropdown-item" href="../articles/plotting.html">Visualizing and compressing segregation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/elbersb/segregation/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>A walkthrough of the segregation package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/elbersb/segregation/blob/master/vignettes/segregation.Rmd" class="external-link"><code>vignettes/segregation.Rmd</code></a></small>
      <div class="d-none name"><code>segregation.Rmd</code></div>
    </div>

    
    
<p>The <code>segregation</code> package includes functionality to
calculate entropy-based segregation measures, namely the Mutual
Information Index (M) and the Theil Index (H), which is a normalized
version of the M index. The package also includes several methods for
decomposing the index into between/within components and into local
segregation scores, as well as methods to decompose differences in
segregation indices. All of these methods have arguments to obtain
standard errors and confidence intervals through bootstrapping.</p>
<p>Detailed information on these indices can be found in the references
at the end of this vignette.</p>
<div class="section level2">
<h2 id="the-basic-mathematics">The basic mathematics<a class="anchor" aria-label="anchor" href="#the-basic-mathematics"></a>
</h2>
<p>The idea of a segregation index is to summarize a contingency table
to a single number. For instance, we may have a table with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>U</mi><annotation encoding="application/x-tex">U</annotation></semantics></math>
units, say schools or occupations, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>G</mi><annotation encoding="application/x-tex">G</annotation></semantics></math>
groups, say gender or racial groups. For each combination of unit and
group we have a count,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>u</mi><mi>g</mi></mrow></msub><annotation encoding="application/x-tex">t_{ug}</annotation></semantics></math>.
Arranged in a
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>√ó</mo><mi>G</mi></mrow><annotation encoding="application/x-tex">U\times G</annotation></semantics></math>
matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùêì</mi><annotation encoding="application/x-tex">\mathbf{T}</annotation></semantics></math>,
this is what the structure of the data looks like:</p>
<table class="table">
<thead><tr class="header">
<th align="center"></th>
<th align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">g=1</annotation></semantics></math></th>
<th align="center">‚Ä¶</th>
<th align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>=</mo><mi>G</mi></mrow><annotation encoding="application/x-tex">g=G</annotation></semantics></math></th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">u=1</annotation></semantics></math></td>
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>11</mn></msub><annotation encoding="application/x-tex">t_{11}</annotation></semantics></math></td>
<td align="center">‚Ä¶</td>
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mn>1</mn><mi>G</mi></mrow></msub><annotation encoding="application/x-tex">t_{1G}</annotation></semantics></math></td>
</tr>
<tr class="even">
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">u=2</annotation></semantics></math></td>
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>21</mn></msub><annotation encoding="application/x-tex">t_{21}</annotation></semantics></math></td>
<td align="center">‚Ä¶</td>
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mn>2</mn><mi>G</mi></mrow></msub><annotation encoding="application/x-tex">t_{2G}</annotation></semantics></math></td>
</tr>
<tr class="odd">
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">u=3</annotation></semantics></math></td>
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mn>31</mn></msub><annotation encoding="application/x-tex">t_{31}</annotation></semantics></math></td>
<td align="center">‚Ä¶</td>
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mn>3</mn><mi>G</mi></mrow></msub><annotation encoding="application/x-tex">t_{3G}</annotation></semantics></math></td>
</tr>
<tr class="even">
<td align="center">‚Ä¶</td>
<td align="center">‚Ä¶</td>
<td align="center">‚Ä¶</td>
<td align="center">‚Ä¶</td>
</tr>
<tr class="odd">
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mo>=</mo><mi>U</mi></mrow><annotation encoding="application/x-tex">u=U</annotation></semantics></math></td>
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>U</mi><mn>1</mn></mrow></msub><annotation encoding="application/x-tex">t_{U1}</annotation></semantics></math></td>
<td align="center">‚Ä¶</td>
<td align="center"><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mrow><mi>U</mi><mi>G</mi></mrow></msub><annotation encoding="application/x-tex">t_{UG}</annotation></semantics></math></td>
</tr>
</tbody>
</table>
<p>From this matrix, we can define
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><msubsup><mo>‚àë</mo><mrow><mi>u</mi><mo>=</mo><mn>1</mn></mrow><mi>U</mi></msubsup><msubsup><mo>‚àë</mo><mrow><mi>g</mi><mo>=</mo><mn>1</mn></mrow><mi>G</mi></msubsup><msub><mi>t</mi><mrow><mi>u</mi><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">t=\sum_{u=1}^U\sum_{g=1}^G t_{ug}</annotation></semantics></math>,
the total population size. The joint probability of being in unit
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>u</mi><annotation encoding="application/x-tex">u</annotation></semantics></math>
and racial group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>
is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>u</mi><mi>g</mi></mrow></msub><mo>=</mo><msub><mi>t</mi><mrow><mi>u</mi><mi>g</mi></mrow></msub><mi>/</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">p_{ug}=t_{ug}/t</annotation></semantics></math>.
Also define
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>u</mi><mo>‚ãÖ</mo></mrow></msub><mo>=</mo><msubsup><mo>‚àë</mo><mrow><mi>g</mi><mo>=</mo><mn>1</mn></mrow><mi>G</mi></msubsup><msub><mi>t</mi><mrow><mi>u</mi><mi>g</mi></mrow></msub><mi>/</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">p_{u \cdot}=\sum_{g=1}^{G}t_{ug}/t</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mo>‚ãÖ</mo><mi>g</mi></mrow></msub><mo>=</mo><msubsup><mo>‚àë</mo><mrow><mi>u</mi><mo>=</mo><mn>1</mn></mrow><mi>U</mi></msubsup><msub><mi>t</mi><mrow><mi>u</mi><mi>g</mi></mrow></msub><mi>/</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">p_{\cdot g}=\sum_{u=1}^{U}t_{ug}/t</annotation></semantics></math>
as the marginal probabilities of units and groups, respectively. The
<strong>Mutual Information Index</strong> is then defined as</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>‚àë</mo><mrow><mi>u</mi><mo>=</mo><mn>1</mn></mrow><mi>U</mi></munderover><munderover><mo>‚àë</mo><mrow><mi>g</mi><mo>=</mo><mn>1</mn></mrow><mi>G</mi></munderover><msub><mi>p</mi><mrow><mi>u</mi><mi>g</mi></mrow></msub><mo>log</mo><mfrac><msub><mi>p</mi><mrow><mi>u</mi><mi>g</mi></mrow></msub><mrow><msub><mi>p</mi><mrow><mi>u</mi><mo>‚ãÖ</mo></mrow></msub><msub><mi>p</mi><mrow><mo>‚ãÖ</mo><mi>g</mi></mrow></msub></mrow></mfrac><mi>.</mi></mrow><annotation encoding="application/x-tex">
M(\mathbf{T})=\sum_{u=1}^U\sum_{g=1}^Gp_{ug}\log\frac{p_{ug}}{p_{u \cdot}p_{\cdot g}}.
</annotation></semantics></math> The <strong>Theil Index</strong> is
closely related to the M index, as it is just a normalized version of
the Mutual Information Index:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mi>M</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>,</mo></mrow><annotation encoding="application/x-tex">
H(\mathbf{T})=\frac{M(\mathbf{T})}{E(\mathbf{T})},
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">E(\mathbf{T})</annotation></semantics></math>
denotes the entropy of the group marginal distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùêì</mi><annotation encoding="application/x-tex">\mathbf{T}</annotation></semantics></math>,
i.e.¬†<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>‚àí</mo><msubsup><mo>‚àë</mo><mrow><mi>g</mi><mo>=</mo><mn>1</mn></mrow><mi>G</mi></msubsup><msub><mi>p</mi><mrow><mo>‚ãÖ</mo><mi>g</mi></mrow></msub><mo>log</mo><msub><mi>p</mi><mrow><mo>‚ãÖ</mo><mi>g</mi></mrow></msub></mrow><annotation encoding="application/x-tex">E(\mathbf{T})=-\sum_{g=1}^{G}p_{\cdot g}\log p_{\cdot g}</annotation></semantics></math>.
Dividing through the group entropy has the effect of constraining H to
be between 0 and 1.</p>
</div>
<div class="section level2">
<h2 id="data-format">Data format<a class="anchor" aria-label="anchor" href="#data-format"></a>
</h2>
<p>For the examples, we will use a dataset built into the
<code>segregation</code> package, <code>schools00</code>. This dataset
contains data on 2,045 schools across 429 school districts in three U.S.
states. For each school, the dataset records the number of Asian, Black,
Hispanic, White, and Native American students. The
<code>segregation</code> package requires data in long form (because
most segregation data comes in this form), not in the form of
contingency tables. Hence, each row of the <code>schools00</code>
dataset is a unique combination of a given school and a racial group,
and the column <code>n</code> records the number of students for this
combination:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://elbersb.github.io/segregation/" class="external-link">"segregation"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">schools00</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"school"</span>, <span class="st">"race"</span>, <span class="st">"n"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;   school  race   n</span></span>
<span><span class="co">#&gt; 1   A1_1 asian   2</span></span>
<span><span class="co">#&gt; 2   A1_1 black  14</span></span>
<span><span class="co">#&gt; 3   A1_1  hisp  30</span></span>
<span><span class="co">#&gt; 4   A1_1 white 351</span></span>
<span><span class="co">#&gt; 5   A1_2 black   9</span></span>
<span><span class="co">#&gt; 6   A1_2  hisp 101</span></span></code></pre></div>
<p>Note that in the first school, <code>A1_1</code>, there are no Native
American students. Hence, that row is missing.</p>
<p>If you have data in the form of contingency tables, you can use
<code><a href="../reference/matrix_to_long.html">matrix_to_long()</a></code> to convert them to the long format
required for the package. As an example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">30</span>, <span class="fl">20</span>, <span class="fl">10</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1] [,2]</span></span>
<span><span class="co">#&gt; [1,]   10   30</span></span>
<span><span class="co">#&gt; [2,]   20   20</span></span>
<span><span class="co">#&gt; [3,]   30   10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Black"</span>, <span class="st">"White"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matrix_to_long.html">matrix_to_long</a></span><span class="op">(</span><span class="va">m</span>, group <span class="op">=</span> <span class="st">"race"</span>, unit <span class="op">=</span> <span class="st">"school"</span><span class="op">)</span></span>
<span><span class="co">#&gt;    school   race     n</span></span>
<span><span class="co">#&gt;    &lt;char&gt; &lt;char&gt; &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      1  Black    10</span></span>
<span><span class="co">#&gt; 2:      2  Black    20</span></span>
<span><span class="co">#&gt; 3:      3  Black    30</span></span>
<span><span class="co">#&gt; 4:      1  White    30</span></span>
<span><span class="co">#&gt; 5:      2  White    20</span></span>
<span><span class="co">#&gt; 6:      3  White    10</span></span></code></pre></div>
<p>The <code>group</code> and <code>unit</code> arguments are
optional.</p>
</div>
<div class="section level2">
<h2 id="computing-the-m-and-h-indices">Computing the M and H indices<a class="anchor" aria-label="anchor" href="#computing-the-m-and-h-indices"></a>
</h2>
<p>Compute the M and H indices using <code><a href="../reference/mutual_total.html">mutual_total()</a></code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mutual_total.html">mutual_total</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"school"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;      stat       est</span></span>
<span><span class="co">#&gt;    &lt;char&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      M 0.4255390</span></span>
<span><span class="co">#&gt; 2:      H 0.4188083</span></span></code></pre></div>
<p>Interpreting the M is not easy, because it is not normalized.
However, the H can range from 0 to 1, so a value of 0.419 would indicate
moderate segregation.</p>
<p>The second argument to <code><a href="../reference/mutual_total.html">mutual_total()</a></code> refers to the
groups, while the third argument refers to the units. Switching groups
and units does not affect the M index, but does change the H index:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mutual_total.html">mutual_total</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"school"</span>, <span class="st">"race"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;      stat        est</span></span>
<span><span class="co">#&gt;    &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      M 0.42553898</span></span>
<span><span class="co">#&gt; 2:      H 0.05642991</span></span></code></pre></div>
<p>This is because the <code>segregation</code> package always divides
by the marginal <em>group</em> entropy, and it would here hence divide
by the entropy of the school distribution, which we would expect to be
much larger (as there are many more schools than racial groups). To
check, we can use the <code><a href="../reference/entropy.html">entropy()</a></code> function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="fu"><a href="../reference/entropy.html">entropy</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.016071</span></span>
<span><span class="op">(</span><span class="fu"><a href="../reference/entropy.html">entropy</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"school"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 7.541018</span></span></code></pre></div>
<p>Therefore, if the H index is used, it is important to specify the
groups and units correctly.</p>
<p>For inference (discussed in more detail <a href="#inference">below</a>), we can use bootstrapping to obtain
standard errors and confidence intervals:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mutual_total.html">mutual_total</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"school"</span>,</span>
<span>  weight <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>  se <span class="op">=</span> <span class="cn">TRUE</span>, CI <span class="op">=</span> <span class="fl">.95</span>, n_bootstrap <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; 500 bootstrap iterations on 877739 observations</span></span>
<span><span class="co">#&gt;      stat       est           se                  CI        bias</span></span>
<span><span class="co">#&gt;    &lt;char&gt;     &lt;num&gt;        &lt;num&gt;              &lt;list&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      M 0.4219677 0.0007802234 0.4204723,0.4234911 0.003571264</span></span>
<span><span class="co">#&gt; 2:      H 0.4153241 0.0006804194 0.4141087,0.4166140 0.003484230</span></span></code></pre></div>
<p>As there a large number of observations, the standard errors are very
small.</p>
</div>
<div class="section level2">
<h2 id="between-within-decomposition">Between-Within decomposition<a class="anchor" aria-label="anchor" href="#between-within-decomposition"></a>
</h2>
<p>We might wonder whether segregation is different across the three
different states. We can compute their segregation indices manually
(just showing the M for simplicity):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">split_schools</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="va">schools00</span><span class="op">$</span><span class="va">state</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/mutual_total.html">mutual_total</a></span><span class="op">(</span><span class="va">split_schools</span><span class="op">$</span><span class="va">A</span>, <span class="st">"race"</span>, <span class="st">"school"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;      stat       est</span></span>
<span><span class="co">#&gt;    &lt;char&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      M 0.4085965</span></span>
<span><span class="fu"><a href="../reference/mutual_total.html">mutual_total</a></span><span class="op">(</span><span class="va">split_schools</span><span class="op">$</span><span class="va">B</span>, <span class="st">"race"</span>, <span class="st">"school"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;      stat       est</span></span>
<span><span class="co">#&gt;    &lt;char&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      M 0.2549959</span></span>
<span><span class="fu"><a href="../reference/mutual_total.html">mutual_total</a></span><span class="op">(</span><span class="va">split_schools</span><span class="op">$</span><span class="va">C</span>, <span class="st">"race"</span>, <span class="st">"school"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;      stat       est</span></span>
<span><span class="co">#&gt;    &lt;char&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      M 0.3450221</span></span></code></pre></div>
<p>Clearly, state A is more segregated than state C, which in turn shows
higher school segregation than B. One of the advantages of entropy-based
segregation indices is that these three state-specific indices have a
simple relationship to the overall index. This is called the
between/within decomposition: Total segregation can be decomposed into a
term that measures how much the distribution of racial groups differs
<em>between</em> states, and into a term that measures segregation
<em>within</em> states. If we have
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
states (or ‚Äúsuper-units‚Äù more generally), where each school belongs to
exactly one state, the M index can be decomposed as follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>M</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêí</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><munderover><mo>‚àë</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></munderover><msub><mi>p</mi><mi>s</mi></msub><mi>M</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêì</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">
M(\mathbf{T})=M(\mathbf{S}) + \sum_{s=1}^S p_s M(\mathbf{T}_s),
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùêì</mi><annotation encoding="application/x-tex">\mathbf{T}</annotation></semantics></math>
is the full
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mo>√ó</mo><mi>G</mi></mrow><annotation encoding="application/x-tex">U \times G</annotation></semantics></math>
contingency table,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùêí</mi><annotation encoding="application/x-tex">\mathbf{S}</annotation></semantics></math>
is the aggregated contingency table of dimension
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>√ó</mo><mi>G</mi></mrow><annotation encoding="application/x-tex">S\times G</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>s</mi></msub><annotation encoding="application/x-tex">p_s</annotation></semantics></math>
is the population proportion of state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>
(such that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>‚àë</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></msubsup><msub><mi>p</mi><mi>s</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sum_{s=1}^S p_s=1</annotation></semantics></math>),
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ùêì</mi><mi>s</mi></msub><annotation encoding="application/x-tex">\mathbf{T}_s</annotation></semantics></math>
is the subset of rows of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ùêì</mi><annotation encoding="application/x-tex">\mathbf{T}</annotation></semantics></math>
belonging to state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>.
Put in simple terms, the M index can be decomposed into a between-state
segregation index, plus a weighted average of within-state M
indices.</p>
<p>For the H index, we are dividing the above formula by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">E(\mathbf{T})</annotation></semantics></math>.
This makes the formula a bit more complicated, because the normalization
has to be offset in the decomposition:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>H</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêí</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><munderover><mo>‚àë</mo><mrow><mi>s</mi><mo>=</mo><mn>1</mn></mrow><mi>S</mi></munderover><mfrac><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêì</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><msub><mi>p</mi><mi>s</mi></msub><mi>H</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêì</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mrow><annotation encoding="application/x-tex">
H(\mathbf{T})=H(\mathbf{S}) + \sum_{s=1}^S \frac{E(\mathbf{T}_s)}{E(\mathbf{T})} p_s H(\mathbf{T}_s),
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>‚ãÖ</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">E(\cdot)</annotation></semantics></math>
is again the entropy of the marginal group distribution. Note that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêí</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">E(\mathbf{T})=E(\mathbf{S})</annotation></semantics></math>,
because the group marginal distributions are identical.</p>
<p>To compute the decomposition using the <code>segregation</code>
package, use:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># total segregation</span></span>
<span><span class="op">(</span><span class="va">total</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mutual_total.html">mutual_total</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"school"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      stat       est</span></span>
<span><span class="co">#&gt;    &lt;char&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      M 0.4255390</span></span>
<span><span class="co">#&gt; 2:      H 0.4188083</span></span>
<span><span class="co"># between-state segregation:</span></span>
<span><span class="co">#     how much does the racial distributions differ across states?</span></span>
<span><span class="op">(</span><span class="va">between</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mutual_total.html">mutual_total</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"state"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      stat        est</span></span>
<span><span class="co">#&gt;    &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      M 0.09924370</span></span>
<span><span class="co">#&gt; 2:      H 0.09767398</span></span>
<span><span class="co"># within-state segregation:</span></span>
<span><span class="co">#     how much segregation exist within states?</span></span>
<span><span class="op">(</span><span class="fu"><a href="../reference/mutual_total.html">mutual_total</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"school"</span>, within <span class="op">=</span> <span class="st">"state"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      stat       est</span></span>
<span><span class="co">#&gt;    &lt;char&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      M 0.3262953</span></span>
<span><span class="co">#&gt; 2:      H 0.3211343</span></span></code></pre></div>
<p>Note that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.426</mn><mo>=</mo><mn>0.0992</mn><mo>+</mo><mn>0.326</mn></mrow><annotation encoding="application/x-tex">0.426 = 0.0992 + 0.326</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.419</mn><mo>=</mo><mn>0.0977</mn><mo>+</mo><mn>0.321</mn></mrow><annotation encoding="application/x-tex">0.419 = 0.0977 + 0.321</annotation></semantics></math>.
The results indicate that about 75% of the segregation is within states.
In other words, differences in the racial composition of the three
different states account for less than 25% of segregation.</p>
<p>By using <code><a href="../reference/mutual_total.html">mutual_total()</a></code> with the <code>within</code>
argument, we can obtain the overall within component, but we do not
obtain the decomposition by state. To do so, we can use
<code><a href="../reference/mutual_within.html">mutual_within()</a></code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">within</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mutual_within.html">mutual_within</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"school"</span>,</span>
<span>  within <span class="op">=</span> <span class="st">"state"</span>, weight <span class="op">=</span> <span class="st">"n"</span>, wide <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;state&gt;</span></span>
<span><span class="co">#&gt;     state         M         p         H ent_ratio</span></span>
<span><span class="co">#&gt;    &lt;fctr&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;     &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      A 0.4085965 0.2768819 0.4969216 0.8092501</span></span>
<span><span class="co">#&gt; 2:      B 0.2549959 0.4035425 0.2680884 0.9361190</span></span>
<span><span class="co">#&gt; 3:      C 0.3450221 0.3195756 0.3611257 0.9402955</span></span></code></pre></div>
<p>This is a much simpler way to obtain state-specific segregation
scores compared to subsetting manually, as shown in the beginning of
this section. In addition to the M and H indices, we also obtain
<code>p</code>, the population proportion of the state
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>s</mi></msub><annotation encoding="application/x-tex">p_s</annotation></semantics></math>
above), and <code>ent_ratio</code>, which is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêì</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mi>E</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">E(\mathbf{T}_s)/E(\mathbf{T})</annotation></semantics></math>
from above. Hence, we can recover the total within-component using</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">within</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">M</span> <span class="op">*</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3262953</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">within</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">H</span> <span class="op">*</span> <span class="va">p</span> <span class="op">*</span> <span class="va">ent_ratio</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3211343</span></span></code></pre></div>
<p>which is exactly the same as before. The quantity
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>s</mi></msub><mi>M</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêì</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">p_s M(\mathbf{T}_s)</annotation></semantics></math>
is itself of interest, because it shows how much the states contribute
to the segregation total, when taking into account their size. By adding
the between component, we can calculate the contribution of the four
components:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># merge into a vector</span></span>
<span><span class="va">components</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">between</span><span class="op">$</span><span class="va">est</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">within</span><span class="op">$</span><span class="va">M</span> <span class="op">*</span> <span class="va">within</span><span class="op">$</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">components</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Between"</span>, <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="va">components</span> <span class="op">/</span> <span class="va">total</span><span class="op">$</span><span class="va">est</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Between       A       B       C </span></span>
<span><span class="co">#&gt;    23.3    26.6    24.2    25.9</span></span></code></pre></div>
<p>Each of the four components contributes about a quarter to the total
segregation of 0.426. Note that state A is the smallest state (27.7% of
the population), but contributes the largest percentage (26.6%) to total
segregation. Hence, the decomposition shows that it is important to look
at both
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>s</mi></msub><annotation encoding="application/x-tex">p_s</annotation></semantics></math>,
the state sizes, as well as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>ùêì</mi><mi>s</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">M(\mathbf{T}_s)</annotation></semantics></math>,
within-state segregation.</p>
<p>The between-within decomposition can also be applied repeatedly in a
hierarchical setting. For instance, in the <code>schools00</code>
dataset, schools are nested within districts, and districts are nested
within states. Therefore, we can ask: How much segregation is due to
segregation between states, how much segregation is due to
between-district segregation within states, and how much segregation is
due to between-school segregation within districts? The package provides
a convenience function for this use case:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mutual_total_nested.html">mutual_total_nested</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"district"</span>, <span class="st">"school"</span><span class="op">)</span>,</span>
<span>  weight <span class="op">=</span> <span class="st">"n"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     between          within   stat        est</span></span>
<span><span class="co">#&gt;      &lt;char&gt;          &lt;char&gt; &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    state                      M 0.09924370</span></span>
<span><span class="co">#&gt; 2:    state                      H 0.09767398</span></span>
<span><span class="co">#&gt; 3: district           state      M 0.23870880</span></span>
<span><span class="co">#&gt; 4: district           state      H 0.23493319</span></span>
<span><span class="co">#&gt; 5:   school state, district      M 0.08758648</span></span>
<span><span class="co">#&gt; 6:   school state, district      H 0.08620114</span></span>
<span><span class="co"># This is a simpler way of running the following three decompositions manually:</span></span>
<span><span class="co"># mutual_total(schools00, "race", "state", weight = "n")</span></span>
<span><span class="co"># mutual_total(schools00, "race", "district", within = "state", weight = "n")</span></span>
<span><span class="co"># mutual_total(schools00, "race", "school", within = c("state", "district"), weight = "n")</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="local-segregation">Local segregation<a class="anchor" aria-label="anchor" href="#local-segregation"></a>
</h2>
<p>The M index (but not the H index) allows for another decomposition,
into local segregation scores. To define this decomposition, let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>g</mi><mo stretchy="false" form="prefix">|</mo><mi>u</mi></mrow></msub><mo>=</mo><msub><mi>t</mi><mrow><mi>u</mi><mi>g</mi></mrow></msub><mi>/</mi><msub><mi>t</mi><mrow><mi>u</mi><mo>‚ãÖ</mo></mrow></msub></mrow><annotation encoding="application/x-tex">p_{g|u} = t_{ug} / t_{u \cdot}</annotation></semantics></math>
be the conditional probability of being in group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math>,
given that one is in unit
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>u</mi><annotation encoding="application/x-tex">u</annotation></semantics></math>.
We can then define the <em>local segregation score of unit
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>u</mi><annotation encoding="application/x-tex">u</annotation></semantics></math></em>
as</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>u</mi></msub><mo>=</mo><munderover><mo>‚àë</mo><mrow><mi>g</mi><mo>=</mo><mn>1</mn></mrow><mi>G</mi></munderover><msub><mi>p</mi><mrow><mi>g</mi><mo stretchy="false" form="prefix">|</mo><mi>u</mi></mrow></msub><mo>log</mo><mfrac><msub><mi>p</mi><mrow><mi>g</mi><mo stretchy="false" form="prefix">|</mo><mi>u</mi></mrow></msub><msub><mi>p</mi><mrow><mo>‚ãÖ</mo><mi>g</mi></mrow></msub></mfrac></mrow><annotation encoding="application/x-tex">L_u = \sum_{g=1}^G p_{g|u}\log\frac{p_{g|u}}{p_{\cdot g}}</annotation></semantics></math>
The weighted average of the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>L</mi><mi>u</mi></msub><annotation encoding="application/x-tex">L_u</annotation></semantics></math>
is again
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">M(\mathbf{T})</annotation></semantics></math>,
i.e.¬†<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>‚àë</mo><mrow><mi>u</mi><mo>=</mo><mn>1</mn></mrow><mi>U</mi></msubsup><msub><mi>p</mi><mrow><mi>u</mi><mo>‚ãÖ</mo></mrow></msub><msub><mi>L</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">M(\mathbf{T}) = \sum_{u=1}^U p_{u\cdot}L_u</annotation></semantics></math>.</p>
<p>To obtain the local segregation scores
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>L</mi><mi>u</mi></msub><annotation encoding="application/x-tex">L_u</annotation></semantics></math>,
along with the marginal weights
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mrow><mi>u</mi><mo>‚ãÖ</mo></mrow></msub><annotation encoding="application/x-tex">p_{u\cdot}</annotation></semantics></math>,
use <code><a href="../reference/mutual_local.html">mutual_local()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mutual_local.html">mutual_local</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"school"</span>, weight <span class="op">=</span> <span class="st">"n"</span>, wide <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;school&gt;</span></span>
<span><span class="co">#&gt;       school        ls            p</span></span>
<span><span class="co">#&gt;       &lt;fctr&gt;     &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt;    1:   A1_1 0.1826710 0.0004522985</span></span>
<span><span class="co">#&gt;    2:   A1_2 0.1825592 0.0004978701</span></span>
<span><span class="co">#&gt;    3:   A1_3 0.2756157 0.0006642066</span></span>
<span><span class="co">#&gt;    4:   A1_4 0.1368034 0.0005685061</span></span>
<span><span class="co">#&gt;    5:   A2_1 0.3585546 0.0004260948</span></span>
<span><span class="co">#&gt;   ---                              </span></span>
<span><span class="co">#&gt; 2041: C165_1 0.3174930 0.0004568556</span></span>
<span><span class="co">#&gt; 2042: C165_2 0.3835477 0.0005297702</span></span>
<span><span class="co">#&gt; 2043: C165_3 0.2972550 0.0005650883</span></span>
<span><span class="co">#&gt; 2044: C166_1 0.3072281 0.0011586588</span></span>
<span><span class="co">#&gt; 2045: C167_1 0.3166498 0.0005354667</span></span></code></pre></div>
<p>Local segregation scores are based on much less data than the full M
index, so it often makes sense to obtain confidence intervals. The
following code plots the length of the 95% confidence interval in
relation to the size of each school:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">localse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mutual_local.html">mutual_local</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"school"</span>,</span>
<span>  weight <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>  se <span class="op">=</span> <span class="cn">TRUE</span>, wide <span class="op">=</span> <span class="cn">TRUE</span>, n_bootstrap <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; 500 bootstrap iterations on 877739 observations</span></span>
<span><span class="va">localse</span><span class="op">$</span><span class="va">lengthCI</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">localse</span><span class="op">$</span><span class="va">ls_CI</span>, <span class="fu">base</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">localse</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span>, y <span class="op">=</span> <span class="va">lengthCI</span>, pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="segregation_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>Although the relationship is not deterministic, larger schools have
shorter confidence intervals.</p>
<p>Because the M is symmetric, local segregation scores can also be
obtained for groups. The equivalent definition for the <em>local
segregation score of group
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>g</mi><annotation encoding="application/x-tex">g</annotation></semantics></math></em>
is then</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>g</mi></msub><mo>=</mo><munderover><mo>‚àë</mo><mrow><mi>u</mi><mo>=</mo><mn>1</mn></mrow><mi>U</mi></munderover><msub><mi>p</mi><mrow><mi>u</mi><mo stretchy="false" form="prefix">|</mo><mi>g</mi></mrow></msub><mo>log</mo><mfrac><msub><mi>p</mi><mrow><mi>u</mi><mo stretchy="false" form="prefix">|</mo><mi>g</mi></mrow></msub><msub><mi>p</mi><mrow><mi>u</mi><mo>‚ãÖ</mo></mrow></msub></mfrac><mo>,</mo></mrow><annotation encoding="application/x-tex">L_g = \sum_{u=1}^U p_{u|g}\log\frac{p_{u|g}}{p_{u \cdot}},</annotation></semantics></math></p>
<p>and, as expected,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùêì</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>‚àë</mo><mrow><mi>g</mi><mo>=</mo><mn>1</mn></mrow><mi>G</mi></msubsup><msub><mi>p</mi><mrow><mo>‚ãÖ</mo><mi>g</mi></mrow></msub><msub><mi>L</mi><mi>g</mi></msub></mrow><annotation encoding="application/x-tex">M(\mathbf{T}) = \sum_{g=1}^G p_{\cdot g}L_g</annotation></semantics></math>.</p>
<p>To obtain these scores, switch the group and unit arguments in
<code>mutual_local</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">localg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mutual_local.html">mutual_local</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"school"</span>, <span class="st">"race"</span>, weight <span class="op">=</span> <span class="st">"n"</span>, wide <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;race&gt;</span></span>
<span><span class="co">#&gt;      race        ls           p</span></span>
<span><span class="co">#&gt;    &lt;fctr&gt;     &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  asian 0.6287673 0.022553401</span></span>
<span><span class="co">#&gt; 2:  black 0.8805413 0.190149919</span></span>
<span><span class="co">#&gt; 3:   hisp 0.7766327 0.151696575</span></span>
<span><span class="co">#&gt; 4:  white 0.1836393 0.628092178</span></span>
<span><span class="co">#&gt; 5: native 1.4342644 0.007507927</span></span></code></pre></div>
<p>These results show that the racial groups experience very different
levels of segregation: White students are less segregated than Asian,
Black, Hispanic, and, especially, Native American students.</p>
</div>
<div class="section level2">
<h2 id="inference">Inference<a class="anchor" aria-label="anchor" href="#inference"></a>
</h2>
<p>The four main functions of the packages, <code><a href="../reference/mutual_total.html">mutual_total()</a></code>,
<code><a href="../reference/mutual_within.html">mutual_within()</a></code>, <code><a href="../reference/mutual_local.html">mutual_local()</a></code>, and
<code><a href="../reference/mutual_difference.html">mutual_difference()</a></code> all support inference through
bootstrapping. Inference for segregation indices is tricky, and the
standard error estimates and confidence intervals should not be trusted
too much when there is little data, and especially when the segregation
index is very close to either 0 or maximum segregation.</p>
<p>To estimate standard errors and confidence intervals, use
<code>se = TRUE</code>. The coverage of the confidence interval can be
specified in the <code>CI</code> argument. The number of bootstrap
iterations can be specified as well:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mutual_total.html">mutual_total</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"school"</span>,</span>
<span>  weight <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>  se <span class="op">=</span> <span class="cn">TRUE</span>, CI <span class="op">=</span> <span class="fl">.95</span>, n_bootstrap <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 500 bootstrap iterations on 877739 observations</span></span>
<span><span class="co">#&gt;      stat       est           se                  CI        bias</span></span>
<span><span class="co">#&gt;    &lt;char&gt;     &lt;num&gt;        &lt;num&gt;              &lt;list&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      M 0.4218995 0.0007976709 0.4202683,0.4234004 0.003639510</span></span>
<span><span class="co">#&gt; 2:      H 0.4152204 0.0007404209 0.4138122,0.4166655 0.003587886</span></span></code></pre></div>
<p>The confidence intervals are based on the percentiles from the
bootstrap distribution, and hence require a large number of bootstrap
iterations for valid interpretation. The estimate <code>est</code> that
is reported in the results has already been ‚Äúdebiased‚Äù, i.e.¬†the bias
that has been estimated from the bootstrap distribution (which is
reported in <code>bias</code>) has been subtracted from the usual
maximum-likelihood estimate that we would obtain from
<code>mutual_total</code> with <code>se = FALSE</code>. The confidence
interval is centered around the debiased estimate.</p>
<p>On balance, confidence intervals are preferred over the standard
error because the bootstrap distribution can be skewed, especially when
segregation is very low or very high. For this example, we can see that
the standard errors provide almost identical coverage to the confidence
intervals, as</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># M</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">se</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">est</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">est</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.4203360 0.4234629</span></span>
<span><span class="co"># H</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">se</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">est</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">est</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.4137692 0.4166717</span></span></code></pre></div>
<p>provide effectively the same coverage as the confidence intervals
obtained from the percentile bootstrap.</p>
<p>Whenever the bootstrap is used, the bootstrap distributions for each
parameter are reported in an attribute <code>bootstrap</code> of the
returned object. This can be used, for instance, to check whether the
bootstrap distribution is skewed. The following code computes local
segregation scores for all schools, and then shows a histogram of the
bootstrap distribution for school C137_9, which has a very low local
segregation score:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">local</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mutual_local.html">mutual_local</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"school"</span>,</span>
<span>  weight <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>  se <span class="op">=</span> <span class="cn">TRUE</span>, CI <span class="op">=</span> <span class="fl">.95</span>, n_bootstrap <span class="op">=</span> <span class="fl">500</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; 500 bootstrap iterations on 877739 observations</span></span>
<span><span class="co"># pick bootstrap distribution of local segregation scores for school C137_9</span></span>
<span><span class="va">ls_school</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">local</span>, <span class="st">"bootstrap"</span><span class="op">)</span><span class="op">[</span><span class="va">school</span> <span class="op">==</span> <span class="st">"C137_9"</span> <span class="op">&amp;</span> <span class="va">stat</span> <span class="op">==</span> <span class="st">"ls"</span>, <span class="va">boot_est</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">ls_school</span>, main <span class="op">=</span> <span class="st">"Bootstrap distribution for school C137_9"</span><span class="op">)</span></span></code></pre></div>
<p><img src="segregation_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>For this school, the bootstrap distribution is skewed. If precise
inference about this specific school is needed, the standard error
should not be interpreted, and the confidence interval should only be
interpreted when the number of bootstrap iterations is large.</p>
<p>If you are concerned that your contingency table is too small to
provide reliable segregation estimates, the package also provides a
function <code><a href="../reference/mutual_expected.html">mutual_expected()</a></code> that simulates random cell
counts under independence from the marginal distributions of your table.
For the <code>schools00</code> dataset:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mutual_expected.html">mutual_expected</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="st">"race"</span>, <span class="st">"school"</span>, weight <span class="op">=</span> <span class="st">"n"</span>, n_bootstrap <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="co">#&gt;         stat         est           se</span></span>
<span><span class="co">#&gt;       &lt;char&gt;       &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: M under 0 0.004804403 7.677220e-05</span></span>
<span><span class="co">#&gt; 2: H under 0 0.004728413 7.555791e-05</span></span></code></pre></div>
<p>Here, there is no concern about bias due to a small sample size.</p>
</div>
<div class="section level2">
<h2 id="decomposing-differences-in-indices">Decomposing differences in indices<a class="anchor" aria-label="anchor" href="#decomposing-differences-in-indices"></a>
</h2>
<p>The command <code><a href="../reference/mutual_difference.html">mutual_difference()</a></code> can be used to decompose
differences in segregation, as described in Elbers (2021). The default,
and recommended method, is to use <code>method = shapley</code> (or
<code>method = shapley_detailed</code>). The other methods
(<code>mrc</code>, <code>km</code>) exist mostly for testing purposes,
and are not recommended. Details on the procedure and how to interpret
the terms of the decomposition are found in Elbers (2021).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mutual_difference.html">mutual_difference</a></span><span class="op">(</span><span class="va">schools00</span>, <span class="va">schools05</span>, <span class="st">"race"</span>, <span class="st">"school"</span>, weight <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;              stat          est</span></span>
<span><span class="co">#&gt;            &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:             M1  0.425538976</span></span>
<span><span class="co">#&gt; 2:             M2  0.413385092</span></span>
<span><span class="co">#&gt; 3:           diff -0.012153884</span></span>
<span><span class="co">#&gt; 4:      additions -0.003412776</span></span>
<span><span class="co">#&gt; 5:       removals -0.011405093</span></span>
<span><span class="co">#&gt; 6: group_marginal  0.017871051</span></span>
<span><span class="co">#&gt; 7:  unit_marginal -0.011712727</span></span>
<span><span class="co">#&gt; 8:     structural -0.003494338</span></span></code></pre></div>
<p>This method also supports inference by setting
<code>se = TRUE</code>.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Elbers, B. (2021). A Method for Studying Differences in Segregation
Across Time and Space. Sociological Methods &amp; Research. <a href="https://doi.org/10.1177/0049124121986204" class="external-link uri">https://doi.org/10.1177/0049124121986204</a></p>
<p>Mora, R., &amp; Ruiz-Castillo, J. (2011). Entropy-based Segregation
Indices. Sociological Methodology, 41(1), 159‚Äì194. <a href="https://doi.org/10.1111/j.1467-9531.2011.01237.x" class="external-link uri">https://doi.org/10.1111/j.1467-9531.2011.01237.x</a></p>
<p>Theil, H. (1971). Principles of Econometrics. New York: Wiley</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://elbersb.com" class="external-link">Benjamin Elbers</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
